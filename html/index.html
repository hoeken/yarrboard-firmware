<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Yarrboard</title>
    <!-- Icon source: https://icon-icons.com -->
    <!-- shortcut::favicon.png -->
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="stylesheet" type="text/css" href="bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="spectrum.min.css">
    <script src="yarrboard.js"></script>
    <script src="jquery-3.7.0.min.js"></script> 
    <script src="bootstrap.min.js"></script>
    <script src="jscookie.js"></script>
    <script src="spectrum.min.js"></script>
    <script src="marked.min.js"></script>
</head>
<body>
    <script>
        $(document).ready(start_yarrboard);
        let FF_FOUC_FIX;
    </script>
    <div class="col-xl-8 col-lg-10 mx-auto">
        <nav id="navbar" class="navbar sticky-top navbar-expand-md bg-body-tertiary navbar-light bg-light">
            <div class="container-fluid">
                <a class="navbar-brand" onclick="open_page('control')" href="#control">
                    <img src="logo-72.png" alt="Avast ye scurvy dog." width="30" height="30">
                    <span id="boardName">Yarrboard</span>
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav">
                        <li id="controlNav" class="nav-item">
                            <a class="nav-link active" onclick="open_page('control')" aria-current="page" href="#control">Control</a>
                        </li>
                        <li id="configNav" class="nav-item">
                            <a class="nav-link" onclick="open_page('config')" href="#config">Config</a>
                        </li>
                        <li id="statsNav" class="nav-item">
                            <a class="nav-link" onclick="open_page('stats')" href="#stats">Status</a>
                        </li>
                        <li id="networkNav" class="nav-item">
                            <a class="nav-link" onclick="open_page('network')" href="#network">Network</a>
                        </li>
                        <li id="settingsNav" class="nav-item">
                            <a class="nav-link" onclick="open_page('settings')" href="#settings">Settings</a>
                        </li>
                        <li id="systemNav" class="nav-item">
                            <a class="nav-link" onclick="open_page('system')" href="#system">System</a>
                        </li>
                        <li id="logoutNav" class="nav-item">
                            <a class="nav-link" onclick="open_page('logout')" href="#logout">Logout</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        <script>
            $('.navbar-collapse ul li a').click(function(){ 
                $('.navbar-toggler:visible').click();
            });
            $(function () {
                $('.navbar-collapse ul li a:not(.dropdown-toggle)').bind('click touchstart', function () {
                    $('.navbar-toggler:visible').click();
                });
            });
        </script>
        <main>
            <div id="liveAlertPlaceholder"></div>
            <div id="loading" style="display: none">
                <div class="d-flex justify-content-center align-items-center" style="height: 300px">
                    <div class="spinner-border" role="status" style="width: 7rem; height: 7rem;"></div>
                </div>
            </div>
            <div id="controlPage" style="display:none" class="pageContainer row mt-3 mx-2">
                <div id="controlDiv" style="display:none" class="col-md-12">
                    <h4 class="text-center">MOSFET Outputs</h4>
                    <table id="pwmTable" class="table table-hover">
                        <thead>
                            <tr>
                                <th class="text-center" scope="col">State</th>
                                <th scope="col">Name</th>
                                <th class="text-end" scope="col">PWM</th>
                                <th class="text-end" scope="col">Power</th>
                            </tr>
                        </thead>
                        <tbody id="pwmTableBody" class="table-group-divider"></tbody>
                    </table>
                </div>
                <div id="switchControlDiv" style="display:none" class="col-md-4">
                    <h4 class="text-center">I/O Switches</h4>
                    <table id="switchTable" class="table table-hover">
                        <thead>
                            <tr>
                                <th class="text-center" scope="col">State</th>
                                <th scope="col">Name</th>
                            </tr>
                        </thead>
                        <tbody id="switchTableBody" class="table-group-divider"></tbody>
                    </table>
                </div>
                <div id="rgbControlDiv" style="display:none" class="col-md-4">
                    <h4 class="text-center">RGB LEDs</h4>
                    <table id="rgbTable" class="table table-hover">
                        <thead>
                            <tr>
                                <th class="text-center" scope="col">LED</th>
                                <th scope="col">Name</th>
                            </tr>
                        </thead>
                        <tbody id="rgbTableBody" class="table-group-divider"></tbody>
                    </table>
                </div>
                <div id="adcControlDiv" style="display:none" class="col-md-4">
                    <h4 class="text-center">Analog Inputs</h4>
                    <table id="adcTable" class="table table-hover">
                        <thead>
                            <tr>
                                <th scope="col">Name</th>
                                <th class="text-center" scope="col">Reading</th>
                                <th class="text-center" scope="col">Voltage</th>
                                <th class="text-center" scope="col">%</th>
                            </tr>
                        </thead>
                        <tbody id="adcTableBody" class="table-group-divider"></tbody>
                    </table>
                </div>
            </div>
            <div id="configPage" style="display:none" class="pageContainer mt-2 mx-2">
                <form class="row g-3" id="ConfigForm">
                    <div id="boardConfigForm"></div>
                    <div id="pwmConfig" style="display:none" class="col-md-12">
                        <h4 class="text-center">MOSFET Outputs</h4>
                        <div id="pwmConfigForm"></div>
                    </div>
                    <div id="switchConfig" style="display:none" class="col-md-6">
                        <h4 class="text-center">I/O Switches</h4>
                        <div id="switchConfigForm"></div>
                    </div>
                    <div id="rgbConfig" style="display:none" class="col-md-6">
                        <h4 class="text-center">RGB LEDs</h4>
                        <div id="rgbConfigForm"></div>
                    </div>
                    <div id="adcConfig" style="display:none" class="col-md-6">
                        <h4 class="text-center">Analog Inputs</h4>
                        <div id="adcConfigForm"></div>
                    </div>
                </form>
            </div>
            <div id="statsPage" style="display:none" class="pageContainer row mt-3 mx-2">
                <div class="col-sm">
                    <div id="pwmStatsDiv">
                        <h5>PWM Statistics</h5>
                        <table id="pwmStatsTable" class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th scope="col">Channel</th>
                                    <th class="text-end" scope="col">aH</th>
                                    <th class="text-end" scope="col">wH</th>
                                    <th class="text-end" scope="col">Switches</th>
                                    <th class="text-end" scope="col">Trips</th>
                                </tr>
                            </thead>
                            <tbody id="pwmStatsTableBody" class="table-group-divider"></tbody>
                        </table>
                    </div>
                    <div id="switchStatsDiv">
                        <h5>Switch Statistics</h5>
                        <table id="switchStatsTable" class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th scope="col">Name</th>
                                    <th class="text-end" scope="col">On/Off Cycles</th>
                                </tr>
                            </thead>
                            <tbody id="switchStatsTableBody" class="table-group-divider"></tbody>
                        </table>
                    </div>
                </div>
                <div class="col-sm">
                    <h5>Board Statistics</h5>
                    <table id="statsTable" class="table table-striped table-hover">
                        <tbody>
                            <tr>
                                <th scope="row">Firmware Version:</th>
                                <td id="firmware_version" class="text-end"></td>
                            </tr>
                            <tr>
                                <th scope="row">Hardware Version:</th>
                                <td id="hardware_version" class="text-end"></td>
                            </tr>
                            <tr>
                                <th scope="row">Last Reboot Reason:</th>
                                <td id="last_reboot_reason" class="text-end"></td>
                            </tr>
                            <tr id="bus_voltage_row">
                                <th scope="row">Bus Voltage:</th>
                                <td id="bus_voltage" class="text-end"></td>
                            </tr>
                            <tr id="fan_rpm_row">
                                <th scope="row">Fan RPMs:</th>
                                <td id="fan_rpm" class="text-end"></td>
                            </tr>
                            <tr>
                                <th scope="row">Messages:</th>
                                <td id="messages" class="text-end"></td>
                            </tr>
                            <tr>
                                <th scope="row">Loop 'FPS':</th>
                                <td id="fps" class="text-end"></td>
                            </tr>
                            <tr>
                                <th scope="row">Heap Size:</th>
                                <td id="heap_size" class="text-end"></td>
                            </tr>
                            <tr>
                                <th scope="row">Free Heap:</th>
                                <td id="free_heap" class="text-end"></td>
                            </tr>
                            <tr>
                                <th scope="row">Minimum Free Heap:</th>
                                <td id="min_free_heap" class="text-end"></td>
                            </tr>
                            <tr>
                                <th scope="row">Max Alloc Heap:</th>
                                <td id="max_alloc_heap" class="text-end"></td>
                            </tr>
                            <tr>
                                <th scope="row">IP Address:</th>
                                <td id="ip_address" class="text-end"></td>
                            </tr>
                            <tr>
                                <th scope="row">WiFi RSSI:</th>
                                <td id="rssi" class="text-end"></td>
                            </tr>
                            <tr>
                                <th scope="row">UUID:</th>
                                <td id="uuid" class="text-end"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="networkPage" style="display:none" class="pageContainer mt-3 mx-2">
                <div class="row justify-content-center">
                    <div class="col-lg-9 col-md-12 col-10 mb-3">
                        <h5>Network Configuration</h5>
                        <div class="mb-3">
                            <label for="wifi_mode" class="col-form-label">Wifi Mode</label>
                            <div>
                                <select id="wifi_mode" class="form-select" aria-label="Wifi Mode">
                                    <option value="ap">AP (You connect to Yarrboard)</option>
                                    <option value="client">Client (Yarrboard connects to WiFi)</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="wifi_ssid" class="col-form-label">Wifi Name (SSID)</label>
                            <div class="">
                                <input id="wifi_ssid" type="text" class="form-control">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="wifi_pass" class="col-form-label">Wifi Password</label>
                            <div class="">
                                <input id="wifi_pass" type="text" class="form-control">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="local_hostname" class="col-form-label">Local Hostname</label>
                            <div class="input-group">
                                <input id="local_hostname" type="text" class="form-control">
                                <span class="input-group-text">.local</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mb-3 text-center">
                    <button type="button" class="btn btn-primary" onclick="save_network_settings()">Save Settings</button>
                </div>
            </div>
            <div id="settingsPage" style="display:none" class="pageContainer mt-3 mx-2">
                <div class="row justify-content-center">
                    <div class="col-lg-9 col-md-12 col-10 mb-3">
                        <h5>App Configuration</h5>
                        <div class="mb-3">
                            <label for="app_user" class="col-form-label">App Username</label>
                            <div class="">
                                <input id="app_user" type="text" class="form-control">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="app_pass" class="col-form-label">App Password</label>
                            <div class="">
                                <input id="app_pass" type="text" class="form-control">
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="" id="require_login" checked>
                                <label class="form-check-label" for="require_login">
                                  Require login with username / password
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="" id="app_enable_api" checked>
                                <label class="form-check-label" for="app_enable_api">
                                    Enable Web API (<a href="https://github.com/hoeken/yarrboard#web-api-protocol">documentation</a>)
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="" id="app_enable_serial" checked>
                                <label class="form-check-label" for="app_enable_serial">
                                    Enable Serial / USB API (<a href="https://github.com/hoeken/yarrboard#serial-api-protocol">documentation</a>)
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="" id="app_enable_ssl" checked>
                                <label class="form-check-label" for="app_enable_ssl">
                                    Enable SSL / HTTPS Encryption? (<a href="https://github.com/hoeken/yarrboard#enable-ssl">documentation</a>)
                                </label>
                            </div>
                        </div>
                        <div class="mb-3" style="display: none" id="server_cert_container">
                            <label for="server_cert" class="col-form-label">Server Certificate</label>
                            <div class="">
                                <textarea class="form-control" id="server_cert" rows="4"></textarea>
                            </div>
                        </div>
                        <div class="mb-3" style="display: none" id="server_key_container">
                            <label for="server_key" class="col-form-label">Server Private Key</label>
                            <div class="">
                                <textarea class="form-control" id="server_key" rows="4"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mb-3 text-center">
                    <button type="button" class="btn btn-primary" onclick="save_app_settings()">Save Settings</button>
                </div>
            </div>
            <div id="systemPage" style="display:none" class="pageContainer mt-3 mx-2">
                <div class="row justify-content-center">
                    <div class="col-lg-9 col-md-12 col-10 mb-3">
                        <div class="row">
                            <h5>Firmware</h5>
                            <div id="firmware_checking" class="alert alert-secondary" role="alert">
                                Checking for new firmware...
                            </div>
                            <div id="firmware_up_to_date" class="alert alert-success" role="alert" style="display: none">
                                Firmware is up to date.
                            </div>
                            <div id="firmware_update_available" style="display: none" class="alert alert-primary mt-3" role="alert">
                                <h1>New Firmware Available</h1>
                                <ul>
                                    <li>Version: <span id="new_firmware_version"></span> (<a id="firmware_bin" href="">Firmware</a>)</li>
                                </ul>
                                <div id="firmware_changelog" style="display: none">
                                    <h1>Changelog</h1>
                                </div>
                                <button id="btn_update_firmware" type="button" class="btn btn-primary" onclick="update_firmware()">Update Firmware</button>
                                <br/>
                                <div id="progress_wrapper" style="display: none" class="mt-4">
                                    <p>Update may take a while, please be patient.  After an update, this page will refresh. You may need to clear your browser cache after updating the firmware if you are having issues.</p>
                                    Firmware Update:
                                    <div class="progress" role="progressbar" aria-label="Firmware Update" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                        <div id="firmware_progress" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <h5>Miscellaneous</h5>
                            <button class="btn btn-primary mb-3" type="button" onclick="restart_board()">Restart Board</button>
                            <button class="btn btn-danger" type="button" onclick="reset_to_factory()">Reset to Factory Defaults</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="loginPage" style="display:none" class="pageContainer form-signin mt-3 mx-auto">
                <h1 class="text-center"><img class="mb-4" src="/favicon.png" alt="" width="72" height="72"> Yarrboard</h1>
                <div class="form-floating">
                    <input type="username" class="form-control" id="username" placeholder="admin">
                    <label for="username">Username</label>
                </div>
                <div class="form-floating">
                    <input type="password" class="form-control" id="password" placeholder="admin">
                    <label for="password">Password</label>
                </div>
                <button class="btn btn-primary w-100 py-2" onclick="do_login()">Log in</button>
                <p class="text-center text-muted my-2">Default: admin / admin</p>
                <div id="liveAlertPlaceholder"></div>
                <script>
                </script>
            </div>
        </main>
        <footer class="p-4 text-body-secondary text-center">
            <div id="time" style="display: none"></div>
            <div id="uptime_footer" style="display: none"></div>
            <div id="bus_voltage_footer" style="display: none"></div>
            <div id="websocket_status">
                WebSocket:
                <span id="connection_startup" class="connection_status text-primary">CONNECTING</span>
                <span id="connection_good" class="connection_status text-success" style="display: none">CONNECTED</span>
                <span id="connection_retrying" class="connection_status text-warning" style="display: none">RETRYING (<span id="retries_count"></span>s)</span>
                <span id="connection_failed" class="connection_status text-danger" style="display: none">FAILED</span>
            </div>
            <a id="projectName" href="https://github.com/hoeken/yarrboard">Yarrboard</a> &copy; 2023<br>
            <a href="https://www.oshwa.org/"><img src="oshw-logo-antipixel.webp"></a>
        </footer>
    </div>
</body>
</html>